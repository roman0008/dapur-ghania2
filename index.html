<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dapur Ghania</title>
</head>
<body>

<script>
const API = "https://script.google.com/macros/s/AKfycbzPxIs7wWQluONhvAmAMJMEZRD1JOwJDlsto1aRSpgnNI6WIVCZlG8QCWNvRTYlxeEkFQ/exec";
let WA="", ROLE="";
</script>

<h3>Login</h3>
<input id="wa" placeholder="No HP">
<input id="pin" placeholder="PIN">
<button onclick="sendPin()">Kirim PIN</button>
<button onclick="login()">Login</button>

<hr>

<div id="app" style="display:none">

<h3>Katalog</h3>
<div id="products"></div>

<h3>Keranjang</h3>
<div id="cart"></div>
<button onclick="showCheckout()">Checkout</button>

<div id="checkout" style="display:none">
  <h3>Checkout</h3>
  <input id="alamat" placeholder="Alamat"><br>
  <input type="date" id="tgl"><br>
  <input type="time" id="jam"><br>

  <select id="kirim">
    <option>Dikirim</option>
    <option>Ambil Sendiri</option>
  </select><br>

  <select id="payment">
    <option value="FULL">Full Payment</option>
    <option value="DP">DP 50%</option>
  </select><br>

  <select id="metode">
    <option>Transfer</option>
    <option>QRIS</option>
  </select><br>

  <textarea id="catatan" placeholder="Catatan"></textarea><br>
  <button onclick="checkout()">Buat Invoice</button>
</div>

<h3>Invoice Saya</h3>
<div id="inv"></div>

<h3>Admin</h3>
<div id="admin"></div>

</div>

<script>
function sendPin(){
  fetch(API+"?action=sendPin&wa="+wa.value)
  .then(()=>alert("PIN dikirim"));
}

function login(){
  fetch(API+`?action=login&wa=${wa.value}&pin=${pin.value}`)
  .then(r=>r.json())
  .then(d=>{
    if(!d.success) return alert("Login gagal");
    WA=wa.value; ROLE=d.role;
    app.style.display="block";
    load();
  });
}

function load(){
  fetch(API+"?action=products")
  .then(r=>r.json())
  .then(d=>{
    products.innerHTML=d.map(p=>`
      <img src="${p[5]}" width="100%"><br>
      <b>${p[1]}</b> - Rp ${p[2]}<br>
      <button onclick="add('${p[0]}','${p[1]}',${p[2]})">Tambah</button><hr>
    `).join("");
  });
  loadCart();
  loadInv();
  if(ROLE==="admin") loadAdmin();
}

function add(id,n,h){
  fetch(API+`?action=addCart&wa=${WA}&pid=${id}&nama=${n}&harga=${h}`)
  .then(loadCart);
}

function loadCart(){
  fetch(API+`?action=getCart&wa=${WA}`)
  .then(r=>r.json())
  .then(d=>{
    cart.innerHTML=d.map(c=>`${c[2]} x ${c[4]} = Rp ${c[3]}`).join("<br>");
  });
}

function showCheckout(){
  checkout.style.display="block";
}

function checkout(){
  const q=new URLSearchParams({
    action:"checkout",wa:WA,
    alamat:alamat.value,
    tgl:tgl.value,
    jam:jam.value,
    kirim:kirim.value,
    payment:payment.value,
    metode:metode.value,
    catatan:catatan.value
  });
  fetch(API+"?"+q.toString())
  .then(()=>{alert("Invoice dibuat");checkout.style.display="none";loadInv();});
}

function loadInv(){
  fetch(API+`?action=myInvoices&wa=${WA}`)
  .then(r=>r.json())
  .then(d=>{
    inv.innerHTML=d.map(i=>`${i[0]} | ${i[3]} | Rp ${i[2]}`).join("<br>");
  });
}

function loadAdmin(){
  fetch(API+"?action=unpaid")
  .then(r=>r.json())
  .then(d=>{
    admin.innerHTML=d.map(i=>`
      ${i[0]} - ${i[1]} - Rp ${i[2]}
      <button onclick="paid('${i[0]}')">PAID</button><br>
    `).join("");
  });
}

function paid(inv){
  fetch(API+"?action=paid&inv="+inv).then(loadAdmin);
}
</script>

</body>
</html>
